name: Python ML CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'PythonCode/**'
      - 'BloodCellDetection/Python/**'
      - '.github/workflows/python-ci.yml'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - 'PythonCode/**'
      - 'BloodCellDetection/Python/**'
      - '.github/workflows/python-ci.yml'
      - 'requirements.txt'

env:
  PYTHON_VERSION: '3.9'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true  # Enable Git LFS for large model files

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest pytest-cov
        pip install tensorflow==2.13.0  # Use specific stable version
        pip install keras==2.13.1
        pip install opencv-python-headless  # Headless version for CI
        pip install numpy pandas matplotlib scikit-learn
        pip install Pillow
        
        # Install additional dependencies if requirements.txt exists
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Lint Python code with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=.git,__pycache__,venv
        # Exit-zero treats all errors as warnings. GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=.git,__pycache__,venv

    - name: Test Python scripts syntax
      run: |
        echo "ðŸ Testing Python script syntax..."
        
        # Check all Python files for syntax errors
        find . -name "*.py" -not -path "./.git/*" -not -path "./venv/*" | while read file; do
          echo "Checking syntax: $file"
          python -m py_compile "$file"
        done
        
        echo "âœ… All Python files have valid syntax"

    - name: Run Python script validation tests
      run: |
        echo "ðŸ” Running Python script validation tests..."
        
        # Test if scripts can be imported (basic smoke test)
        python -c "
import sys
import os
sys.path.append('BloodCellDetection/Python')
sys.path.append('PythonCode')

# Test basic imports without actually running ML models
try:
    print('Testing basic Python functionality...')
    import numpy as np
    print('âœ… NumPy imported successfully')
    
    # Test if we can import OpenCV
    import cv2
    print('âœ… OpenCV imported successfully')
    
    # Test TensorFlow/Keras import (but not model loading due to size)
    import tensorflow as tf
    print(f'âœ… TensorFlow {tf.__version__} imported successfully')
    
    import keras
    print(f'âœ… Keras {keras.__version__} imported successfully')
    
    print('ðŸŽ‰ All core ML dependencies available!')
    
except ImportError as e:
    print(f'âŒ Import error: {e}')
    sys.exit(1)
"

    - name: Test model file availability
      run: |
        echo "ðŸ¤– Checking ML model files..."
        
        if [ -f "PythonCode/Blood.keras" ]; then
          echo "âœ… Blood.keras model found"
          ls -lh PythonCode/Blood.keras
        else
          echo "âš ï¸ Blood.keras model not found (may be in Git LFS)"
        fi
        
        if [ -f "PythonCode/Blood1.keras" ]; then
          echo "âœ… Blood1.keras model found"
          ls -lh PythonCode/Blood1.keras
        else
          echo "âš ï¸ Blood1.keras model not found (may be in Git LFS)"
        fi
        
        if [ -f "BloodCellDetection/Python/Blood1.keras" ]; then
          echo "âœ… BloodCellDetection Blood1.keras model found"
          ls -lh BloodCellDetection/Python/Blood1.keras
        else
          echo "âš ï¸ BloodCellDetection Blood1.keras model not found (may be in Git LFS)"
        fi

    - name: Run basic ML pipeline test
      run: |
        echo "ðŸ§ª Testing basic ML pipeline..."
        
        python -c "
import numpy as np
import cv2
import tensorflow as tf

# Create a dummy image for testing
dummy_image = np.random.randint(0, 255, (224, 224, 3), dtype=np.uint8)
print('âœ… Created dummy test image')

# Test basic image processing operations
gray = cv2.cvtColor(dummy_image, cv2.COLOR_BGR2GRAY)
print('âœ… OpenCV image processing works')

# Test basic TensorFlow operations
dummy_tensor = tf.constant(dummy_image, dtype=tf.float32)
normalized = dummy_tensor / 255.0
print('âœ… TensorFlow tensor operations work')

print('ðŸŽ‰ Basic ML pipeline test completed successfully!')
"

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install code quality tools
      run: |
        pip install black isort mypy bandit safety

    - name: Check code formatting with Black
      run: |
        black --check --diff . || echo "Code formatting issues found. Run 'black .' to fix."

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff . || echo "Import sorting issues found. Run 'isort .' to fix."

    - name: Security check with Bandit
      run: |
        bandit -r . -f json -o bandit-report.json || true
        if [ -f bandit-report.json ]; then
          echo "ðŸ”’ Security scan completed. Check bandit-report.json for details."
        fi

    - name: Type checking with mypy (optional)
      run: |
        # Run mypy on Python files, but don't fail the build
        find . -name "*.py" -not -path "./.git/*" | head -5 | xargs mypy --ignore-missing-imports || echo "Type checking completed with warnings"

    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: bandit-report.json
        retention-days: 30

  dependency-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install safety pip-audit

    - name: Check for known security vulnerabilities
      run: |
        echo "ðŸ” Checking for known security vulnerabilities..."
        
        # Create a basic requirements list for scanning
        echo "tensorflow==2.13.0
keras==2.13.1
opencv-python-headless
numpy
pandas
matplotlib
scikit-learn
Pillow" > temp-requirements.txt
        
        # Run safety check
        safety check --file temp-requirements.txt --output json --save-json safety-report.json || echo "Safety check completed"
        
        # Run pip-audit
        pip-audit --requirement temp-requirements.txt --format json --output audit-report.json || echo "Audit check completed"
        
        echo "âœ… Dependency security check completed"

    - name: Upload dependency reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-reports
        path: |
          safety-report.json
          audit-report.json
        retention-days: 30